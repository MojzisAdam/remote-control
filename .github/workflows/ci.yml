name: CI

on:
    push:
        branches: [main, develop]
    pull_request:

jobs:
    backend:
        runs-on: ubuntu-latest
        strategy:
            matrix:
                php: [8.4, 8, 3]
        services:
            mysql:
                image: mysql:8.0
                env:
                    MYSQL_ALLOW_EMPTY_PASSWORD: yes
                    MYSQL_DATABASE: remote_control_test
                options: >-
                    --health-cmd "mysqladmin ping"
                    --health-interval 10s
                    --health-timeout 5s
                    --health-retries 3
                ports:
                    - 3306
        steps:
            - uses: actions/checkout@v4

            - name: Set up PHP ${{ matrix.php }}
              uses: shivammathur/setup-php@v2
              with:
                  php-version: ${{ matrix.php }}
                  extensions: mbstring, bcmath, intl, pdo_mysql, xml, ctype, json, tokenizer, dom, fileinfo, openssl, gd

            - name: Cache Composer dependencies
              uses: actions/cache@v4
              with:
                  path: ~/.composer/cache
                  key: composer-cache-${{ runner.os }}-${{ matrix.php }}-${{ hashFiles('backend/composer.lock') }}
                  restore-keys: composer-cache-${{ runner.os }}-${{ matrix.php }}-

            - name: Install PHP dependencies
              working-directory: backend
              run: composer install --no-progress --no-suggest --prefer-dist --no-interaction

            - name: Create .env file
              working-directory: backend
              run: php -r "file_exists('.env') || copy('.env.example', '.env');"

            - name: Generate app key
              working-directory: backend
              run: php artisan key:generate

            - name: PHP Syntax Check
              working-directory: backend
              run: |
                  find . -type f -name '*.php' -print0 | xargs -0 -n1 php -l

            - name: Wait for MySQL
              run: |
                  for i in {1..30}; do
                    if mysqladmin ping -h 127.0.0.1 -P ${{ job.services.mysql.ports[3306] }} --silent; then
                      exit 0
                    fi
                    sleep 1
                  done
                  echo "MySQL did not become ready in time" >&2
                  exit 1
            - name: Run migrations
              working-directory: backend
              env:
                  DB_CONNECTION: mysql
                  DB_HOST: 127.0.0.1
                  DB_PORT: ${{ job.services.mysql.ports[3306] }}
                  DB_DATABASE: remote_control_test
                  DB_USERNAME: root
                  DB_PASSWORD: ""
              run: php artisan migrate --no-interaction --force

            - name: Run tests
              working-directory: backend
              env:
                  DB_CONNECTION: mysql
                  DB_HOST: 127.0.0.1
                  DB_PORT: ${{ job.services.mysql.ports[3306] }}
                  DB_DATABASE: remote_control_test
                  DB_USERNAME: root
                  DB_PASSWORD: ""
              run: php artisan test

    frontend:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4

            - name: Setup Node.js 22.x
              uses: actions/setup-node@v4
              with:
                  node-version: 22.x
                  cache: npm

            - name: Install dependencies
              working-directory: frontend
              run: npm ci

            - name: Create .env file
              working-directory: frontend
              run: cp .env.example .env

            - name: Lint
              working-directory: frontend
              run: npm run lint

            - name: Build and type check
              working-directory: frontend
              run: npm run build

    summary:
        needs: [backend, frontend]
        runs-on: ubuntu-latest
        steps:
            - run: echo "All tests passed successfully!"
