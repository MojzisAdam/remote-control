name: deploy

on:
    workflow_run:
        workflows: ["CI"]
        types:
            - completed

    workflow_dispatch:
        inputs:
            version:
                description: "Release version (např. 1.2.3)"
                required: true

permissions:
    contents: read

concurrency:
    group: deploy-${{ github.ref }}
    cancel-in-progress: true

env:
    SSH_HOST: ${{ secrets.SSH_HOST }}
    SSH_USER: ${{ secrets.SSH_USER }}
    SSH_PORT: ${{ secrets.SSH_PORT }}
    SSH_KEY: ${{ secrets.SSH_KEY }}
    BACKEND_PATH: ${{ secrets.BACKEND_PATH }}

jobs:
    deploy:
        if: >
            (github.event_name == 'workflow_run' &&
            github.event.workflow_run.conclusion == 'success' &&
            startsWith(github.event.workflow_run.head_branch, 'v'))
            ||
            (github.event_name == 'workflow_dispatch')
        runs-on: ubuntu-latest
        steps:
            - name: Checkout
              uses: actions/checkout@v4

    check-version:
        needs: deploy
        runs-on: ubuntu-latest
        outputs:
            deploy: ${{ steps.check.outputs.deploy }}
            version: ${{ steps.extract.outputs.version }}
        steps:
            - name: Extract version
              id: extract
              run: |
                  set +x
                  if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
                    echo "version=${{ github.event.inputs.version }}" >> "$GITHUB_OUTPUT"
                  else
                    RAW="${{ github.event.workflow_run.head_branch }}"
                    CLEAN="${RAW#v}"   # odstraní začínající "v"
                    echo "version=$CLEAN" >> "$GITHUB_OUTPUT"
                  fi

            - name: Compare with deployed version on server
              id: check
              run: |
                  set +x
                  echo "$SSH_KEY" > private_key && chmod 600 private_key
                  version="${{ steps.extract.outputs.version }}"
                  if [ -z "$version" ]; then
                    echo "No version specified. Skipping deploy."
                    echo "deploy=false" >> "$GITHUB_OUTPUT"
                    exit 0
                  fi
                  DEPLOYED_VERSION=$(ssh -i private_key -o StrictHostKeyChecking=accept-new -p "$SSH_PORT" "$SSH_USER@$SSH_HOST" \
                    "cat \"${BACKEND_PATH}/.deploy-version\" 2>/dev/null || echo '0.0.0'")
                  echo "Currently deployed version: $DEPLOYED_VERSION"
                  echo "Incoming version: $version"
                  NEWER=$(printf "%s\n%s" "$DEPLOYED_VERSION" "$version" | sort -V | tail -n1)
                  if [ "$NEWER" = "$version" ]; then
                    echo "deploy=true" >> "$GITHUB_OUTPUT"
                  else
                    echo "Version is not newer. Skipping deploy."
                    echo "deploy=false" >> "$GITHUB_OUTPUT"
                  fi
                  rm -f private_key

    deploy-backend:
        needs: check-version
        if: needs.check-version.outputs.deploy == 'true'
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Prepare SSH key and multiplexing
              run: |
                  echo "$SSH_KEY" > private_key
                  chmod 600 private_key


                  mkdir -p ~/.ssh


                  echo "Host server
                  HostName $SSH_HOST
                  User $SSH_USER
                  Port $SSH_PORT
                  IdentityFile private_key
                  StrictHostKeyChecking accept-new
                  ControlMaster auto
                  ControlPersist 60s
                  ControlPath ~/.ssh/cm-%r@%h:%p
                  " > ~/.ssh/config

            - name: Create staging directory
              run: |
                  ssh server "mkdir -p '${{ secrets.STAGING_BACKEND_PATH }}'"

            - name: Upload backend via rsync
              run: |
                  rsync -avz \
                  --exclude vendor \
                  --exclude node_modules \
                  --exclude .env \
                  -e "ssh" \
                  backend/ server:${{ secrets.STAGING_BACKEND_PATH }}/

            - name: Upload .env file
              run: |
                  echo "${{ secrets.ENV_BACKEND }}" > .env
                  scp .env server:${{ secrets.STAGING_BACKEND_PATH }}/.env

            - name: Install backend dependencies and migrate
              run: |
                  ssh server "cd '${{ secrets.STAGING_BACKEND_PATH }}' && \
                  composer install --no-dev --optimize-autoloader && \
                  php artisan migrate --force && \
                  php artisan db:seed-if-empty && \
                  php artisan config:cache && \
                  php artisan route:cache"

            - name: Promote release to production (with backup)
              run: |
                  ssh server "
                  if [ -d '${{ secrets.BACKEND_PATH }}' ]; then
                  rm -rf '${{ secrets.BACKEND_PREVIOUS }}' && \
                  mv '${{ secrets.BACKEND_PATH }}' '${{ secrets.BACKEND_PREVIOUS }}';
                  fi && \
                  mv '${{ secrets.STAGING_BACKEND_PATH }}' '${{ secrets.BACKEND_PATH }}' && \
                  echo '${{ needs.check-version.outputs.version }}' > '${{ secrets.BACKEND_PATH }}/.deploy-version'
                  "

            - name: Cleanup SSH key
              run: rm -f private_key ~/.ssh/cm-*

    deploy-frontend:
        needs: deploy-backend
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: 22.x
                  cache: npm
                  cache-dependency-path: frontend/package-lock.json

            - name: Install dependencies
              working-directory: frontend
              run: npm ci

            - name: Create frontend .env file from secret
              working-directory: frontend
              run: |
                  set +x
                  echo "${{ secrets.ENV_FRONTEND }}" > .env

            - name: Build frontend
              working-directory: frontend
              run: npm run build

            - name: Upload frontend build to server
              run: |
                  set +x
                  echo "$SSH_KEY" > private_key && chmod 600 private_key
                  rsync -avz --delete \
                    -e "ssh -i private_key -o StrictHostKeyChecking=accept-new -p $SSH_PORT" \
                    frontend/dist/ $SSH_USER@$SSH_HOST:${{ secrets.FRONTEND_PATH }}
                  rm -f private_key
